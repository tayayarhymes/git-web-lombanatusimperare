<?php
/**
 * A single course loop
 *
 * @package Tutor\Templates
 * @subpackage CourseLoopPart
 * @author Themeum
 * @link https://themeum.com
 * @since 1.4.3
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

global $post, $authordata, $wp_query;
$course_id = get_the_ID();
$profile_url       = tutor_utils()->profile_url($authordata->ID, true);

// Safely fetch course details
$course_title = get_the_title($course_id);
$course_permalink = get_the_permalink($course_id);
$course_image_url = get_tutor_course_thumbnail($course_id, 'full'); // Fetch featured image safely
$course_price = tutor_utils()->get_course_price($course_id, true);
$enrolled_students = tutor_utils()->count_enrolled_users_by_course($course_id);
$lessons = tutor_utils()->get_course_lessons($course_id);
$course_categories = get_tutor_course_categories($course_id); // Get course categories

// Determine the current post index
$current_index = $wp_query->current_post; // Starts at 0 for the first post
?>


<div class="td_card td_style_3 d-block td_radius_10">
    <?php if(!empty($course_image_url) ) :?>
    <?php if ($current_index < 3): // Show "New" label for the first 3 posts ?>
        <span class="td_card_label td_accent_bg td_white_color"><?php esc_html_e('New','ystudy-education');?></span>
    <?php endif; ?>
    <a href="<?php echo esc_url($course_permalink); ?>" class="td_card_thumb">
        <img src="<?php echo esc_url($course_image_url); ?>" alt="<?php echo esc_attr($course_title); ?>" />
    </a>
    <?php endif;?>
    <div class="td_card_info td_white_bg">
        <div class="td_card_info_in">
            <ul class="td_card_meta td_mp_0 td_fs_18 td_medium td_heading_color">
                <li>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g opacity="0.7">
                    <path d="M19.352 15.852V13.3536L18.2977 13.7638L18.2946 13.7569L18.2695 13.7112C17.8654 13.0822 17.212 12.6445 16.4763 12.5111L13.9392 12.0495V11.8492C14.888 11.2983 15.5827 10.3583 15.7993 9.24716C16.5022 9.10178 17.0322 8.47814 17.0322 7.73271V3.91391C17.0322 2.83481 16.3255 1.89374 15.3001 1.58752L15.1068 1.39421C14.2075 0.494893 13.012 0 11.7404 0C9.11549 0 6.97972 2.13539 6.97972 4.76064V7.73271C6.97972 8.47814 7.50979 9.10178 8.2127 9.24716C8.4296 10.3583 9.124 11.2986 10.0728 11.8492V12.0495L7.53609 12.5107C6.80109 12.6441 6.14807 13.081 5.74364 13.7097L5.72045 13.7661L4.65991 13.3536V15.852C4.02041 15.852 3.5 16.3725 3.5 17.012V18.5585C3.5 19.198 4.02041 19.7184 4.65991 19.7184V21.1428L12.006 24L19.352 21.1428V19.7184C19.9915 19.7184 20.512 19.198 20.512 18.5585V17.012C20.512 16.3725 19.9915 15.852 19.352 15.852ZM14.6637 12.9674L16.3378 13.2716C16.8308 13.3613 17.2673 13.6459 17.5584 14.0511L13.8177 15.5056L14.6637 12.9674ZM10.8789 12.2038C11.2358 12.3128 11.6139 12.3723 12.006 12.3723C12.398 12.3723 12.7762 12.3128 13.133 12.2038L12.006 13.0489L10.8789 12.2038ZM11.4175 13.574L10.6284 14.3627L10.1165 12.8274L10.3628 12.7829L11.4175 13.574ZM13.6492 12.7833L13.8955 12.8278L13.3836 14.3631L12.5944 13.5744L13.6492 12.7833ZM15.8723 8.39849V7.06692C16.1024 7.20108 16.259 7.44776 16.259 7.73271C16.259 8.01766 16.1024 8.26433 15.8723 8.39849ZM8.13962 8.39849C7.90958 8.26433 7.75299 8.01766 7.75299 7.73271C7.75299 7.44776 7.90958 7.20108 8.13962 7.06692V8.39849ZM8.13962 5.79953V6.24107C8.00198 6.27702 7.87285 6.33115 7.75299 6.40113V4.76064C7.75299 2.56223 9.54156 0.773271 11.7404 0.773271C12.8052 0.773271 13.8069 1.18813 14.5601 1.9413L14.9011 2.28269L15.0051 2.30821C15.7436 2.49264 16.259 3.15301 16.259 3.91391V6.40113C16.1391 6.33115 16.01 6.27664 15.8723 6.24107V5.79953H14.6463C13.5985 5.79953 12.5971 5.29922 11.9689 4.46138L11.6615 4.05078L10.8932 4.81941C10.2607 5.45156 9.42016 5.79953 8.52626 5.79953H8.13962ZM8.91289 8.50598V6.55502C9.8675 6.46648 10.7533 6.05239 11.4399 5.36611L11.5903 5.21571C12.3655 6.07133 13.4822 6.5728 14.6463 6.5728H15.0991V8.50598C15.0991 10.2114 13.7114 11.5991 12.006 11.5991C10.3005 11.5991 8.91289 10.2114 8.91289 8.50598ZM7.67411 13.2716L9.34825 12.9674L10.1942 15.5056L6.45273 14.0507C6.74387 13.6451 7.18115 13.3613 7.67411 13.2716ZM4.27327 18.5585V17.012C4.27327 16.7985 4.44687 16.6253 4.65991 16.6253C5.2994 16.6253 5.81981 17.1457 5.81981 17.7852C5.81981 18.4247 5.2994 18.9451 4.65991 18.9451C4.44687 18.9451 4.27327 18.7719 4.27327 18.5585ZM11.6193 23.0195L5.43318 20.6142V19.5545C6.11481 19.2552 6.59308 18.5759 6.59308 17.7852C6.59308 16.9946 6.11481 16.3152 5.43318 16.016V14.4841L11.6193 16.8898V23.0195ZM10.4714 15.6139L12.006 14.0789L13.5405 15.6135L12.006 16.2105L10.4714 15.6139ZM18.5788 20.6138L12.3926 23.0191V16.8898L18.5788 14.4841V16.016C17.8971 16.3152 17.4189 16.9946 17.4189 17.7852C17.4189 18.5759 17.8971 19.2552 18.5788 19.5545V20.6138ZM19.7387 18.5585C19.7387 18.7719 19.5651 18.9451 19.352 18.9451C18.7126 18.9451 18.1921 18.4247 18.1921 17.7852C18.1921 17.1457 18.7126 16.6253 19.352 16.6253C19.5651 16.6253 19.7387 16.7985 19.7387 17.012V18.5585Z" fill="#00001B"/>
                    </g>
                    </svg>
                    <span class="td_opacity_7"><?php echo esc_html($enrolled_students); ?> <?php esc_html_e('Enrolled','ystudy-education');?></span>
                </li>
                <li>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g opacity="0.7">
                    <path d="M8.56818 10.0859H4.10547C4.00601 10.0859 3.91063 10.1254 3.8403 10.1958C3.76998 10.2661 3.73047 10.3615 3.73047 10.4609C3.73047 10.5604 3.76998 10.6558 3.8403 10.7261C3.91063 10.7964 4.00601 10.8359 4.10547 10.8359H8.56818C8.66631 10.8339 8.75974 10.7935 8.82842 10.7234C8.89711 10.6533 8.93558 10.5591 8.93558 10.4609C8.93558 10.3628 8.89711 10.2686 8.82842 10.1984C8.75974 10.1283 8.66631 10.0879 8.56818 10.0859Z" fill="#00001B"/>
                    <path d="M8.56818 12.3125H4.10547C4.00601 12.3125 3.91063 12.352 3.8403 12.4223C3.76998 12.4927 3.73047 12.588 3.73047 12.6875C3.73047 12.787 3.76998 12.8823 3.8403 12.9527C3.91063 13.023 4.00601 13.0625 4.10547 13.0625H8.56818C8.66631 13.0605 8.75974 13.0201 8.82842 12.95C8.89711 12.8799 8.93558 12.7856 8.93558 12.6875C8.93558 12.5894 8.89711 12.4951 8.82842 12.425C8.75974 12.3549 8.66631 12.3145 8.56818 12.3125Z" fill="#00001B"/>
                    <path d="M8.56818 14.5469H4.10547C4.00601 14.5469 3.91063 14.5864 3.8403 14.6567C3.76998 14.727 3.73047 14.8224 3.73047 14.9219C3.73047 15.0213 3.76998 15.1167 3.8403 15.187C3.91063 15.2574 4.00601 15.2969 4.10547 15.2969H8.56818C8.66631 15.2949 8.75974 15.2545 8.82842 15.1844C8.89711 15.1143 8.93558 15.02 8.93558 14.9219C8.93558 14.8237 8.89711 14.7295 8.82842 14.6594C8.75974 14.5893 8.66631 14.5489 8.56818 14.5469Z" fill="#00001B"/>
                    <path d="M8.56818 16.7734H4.10547C4.00601 16.7734 3.91063 16.8129 3.8403 16.8833C3.76998 16.9536 3.73047 17.049 3.73047 17.1484C3.73047 17.2479 3.76998 17.3433 3.8403 17.4136C3.91063 17.4839 4.00601 17.5234 4.10547 17.5234H8.56818C8.66631 17.5214 8.75974 17.481 8.82842 17.4109C8.89711 17.3408 8.93558 17.2466 8.93558 17.1484C8.93558 17.0503 8.89711 16.9561 8.82842 16.8859C8.75974 16.8158 8.66631 16.7754 8.56818 16.7734Z" fill="#00001B"/>
                    <path d="M13.0315 10.8359H14.4996C14.5991 10.8359 14.6945 10.7964 14.7648 10.7261C14.8351 10.6558 14.8746 10.5604 14.8746 10.4609C14.8746 10.3615 14.8351 10.2661 14.7648 10.1958C14.6945 10.1254 14.5991 10.0859 14.4996 10.0859H13.0315C12.9333 10.0879 12.8399 10.1283 12.7712 10.1984C12.7025 10.2686 12.6641 10.3628 12.6641 10.4609C12.6641 10.5591 12.7025 10.6533 12.7712 10.7234C12.8399 10.7935 12.9333 10.8339 13.0315 10.8359Z" fill="#00001B"/>
                    <path d="M13.0316 13.0703H13.7833C13.8815 13.0683 13.9749 13.028 14.0436 12.9579C14.1124 12.8877 14.1509 12.7935 14.1509 12.6953C14.1509 12.5971 14.1124 12.5029 14.0436 12.4328C13.9749 12.3626 13.8814 12.3223 13.7833 12.3203H13.0316C12.9335 12.3223 12.84 12.3626 12.7713 12.4328C12.7026 12.5029 12.6641 12.5971 12.6641 12.6953C12.6641 12.7935 12.7026 12.8878 12.7713 12.9579C12.84 13.028 12.9335 13.0683 13.0316 13.0703Z" fill="#00001B"/>
                    <path d="M13.0316 15.2969H13.6681C13.7676 15.2969 13.863 15.2574 13.9333 15.187C14.0036 15.1167 14.0431 15.0213 14.0431 14.9219C14.0431 14.8224 14.0036 14.727 13.9333 14.6567C13.863 14.5864 13.7676 14.5469 13.6681 14.5469H13.0316C12.9335 14.5488 12.84 14.5892 12.7713 14.6593C12.7026 14.7294 12.6641 14.8237 12.6641 14.9219C12.6641 15.0201 12.7026 15.1143 12.7713 15.1844C12.84 15.2545 12.9335 15.2949 13.0316 15.2969Z" fill="#00001B"/>
                    <path d="M17.494 16.7734H13.0313C12.9318 16.7734 12.8364 16.8129 12.7661 16.8833C12.6958 16.9536 12.6562 17.049 12.6562 17.1484C12.6562 17.2479 12.6958 17.3433 12.7661 17.4136C12.8364 17.4839 12.9318 17.5234 13.0313 17.5234H17.494C17.5921 17.5214 17.6855 17.481 17.7542 17.4109C17.8229 17.3408 17.8614 17.2466 17.8614 17.1484C17.8614 17.0503 17.8229 16.9561 17.7542 16.8859C17.6855 16.8158 17.5921 16.7754 17.494 16.7734Z" fill="#00001B"/>
                    <path d="M21.6809 2.88904C21.5012 2.75887 21.2957 2.66872 21.0782 2.62466C20.8608 2.58061 20.6364 2.58367 20.4202 2.63365C20.204 2.68363 20.0011 2.77935 19.825 2.91438C19.649 3.04941 19.5039 3.22061 19.3995 3.41644L17.8133 6.52876C15.4646 5.9413 12.9849 6.18608 10.7964 7.22144C9.37415 6.54593 7.81712 6.20212 6.24268 6.21591C4.66823 6.2297 3.11746 6.60073 1.70728 7.30105C1.64498 7.33219 1.59259 7.38007 1.55598 7.43932C1.51937 7.49857 1.49998 7.56685 1.5 7.6365V21.0246C1.50079 21.0883 1.51763 21.1507 1.54896 21.206C1.58029 21.2614 1.6251 21.308 1.67922 21.3415C1.73335 21.3749 1.79505 21.3942 1.85859 21.3974C1.92214 21.4007 1.98548 21.3878 2.04274 21.3601C3.37731 20.6967 4.84739 20.3515 6.33772 20.3515C7.82806 20.3515 9.29814 20.6967 10.6327 21.3601C10.6846 21.3864 10.7419 21.4004 10.8001 21.4008C10.8583 21.4013 10.9158 21.3883 10.9682 21.3628C12.303 20.6993 13.7733 20.354 15.264 20.354C16.7546 20.354 18.225 20.6993 19.5598 21.3628C19.617 21.3906 19.6804 21.4034 19.7439 21.4002C19.8075 21.3969 19.8692 21.3777 19.9233 21.3442C19.9775 21.3108 20.0223 21.2642 20.0536 21.2088C20.0849 21.1534 20.1017 21.091 20.1025 21.0274V9.29583L22.3374 4.91458C22.5177 4.55871 22.5498 4.14594 22.4268 3.76643C22.3038 3.38692 22.0357 3.0715 21.6809 2.88904ZM20.0684 3.7557C20.1599 3.57819 20.3179 3.444 20.5078 3.38234C20.6978 3.32069 20.9044 3.33655 21.0827 3.42648L21.3416 3.55794C21.5194 3.65024 21.6535 3.80912 21.7146 3.99992C21.7758 4.19071 21.759 4.39793 21.6679 4.57639L21.3112 5.27569L19.7097 4.45948L20.0684 3.7557ZM19.392 9.03801C19.378 9.07741 17.3142 13.1075 17.297 13.1456L16.8324 12.9101L20.5035 5.70596L20.9703 5.94388L19.392 9.03801ZM16.0045 14.3562L15.442 14.8118C15.4628 14.3994 15.5119 13.5105 15.5349 13.0926L16.1587 13.4097L16.7782 13.7235L16.0045 14.3562ZM19.3691 5.12779L19.8352 5.36535L16.1635 12.5707L15.6964 12.3332L19.3691 5.12779ZM2.25 20.4374V7.87144C3.52973 7.27337 4.92512 6.96341 6.33771 6.96341C7.7503 6.96341 9.14568 7.27337 10.4254 7.87144V20.4374C9.13313 19.8861 7.74268 19.6019 6.33771 19.6019C4.93274 19.6019 3.54228 19.8861 2.25 20.4374ZM11.1754 20.4402V7.86849C13.1395 6.9575 15.3518 6.72966 17.4603 7.22124L14.8577 12.3277C14.8378 12.3755 14.8243 12.4257 14.8176 12.477C14.7751 13.2592 14.6877 14.8328 14.6451 15.6149C14.642 15.6871 14.6597 15.7586 14.696 15.821C14.7324 15.8834 14.7858 15.9341 14.8501 15.967C14.9144 16 14.9867 16.0138 15.0586 16.0068C15.1305 15.9999 15.1989 15.9725 15.2556 15.9278L16.4795 14.9367L17.6946 13.943C17.701 13.9336 17.7096 13.926 17.7195 13.9206C17.7487 13.8901 17.774 13.8562 17.795 13.8195L19.3525 10.7688V20.4402C18.06 19.8887 16.6692 19.6044 15.264 19.6044C13.8587 19.6044 12.468 19.8887 11.1754 20.4402Z" fill="#00001B"/>
                    </g>
                    </svg>
                    <span class="td_opacity_7"><?php echo tutor_utils()->get_lesson_count_by_course( $course_id ); ?> <?php esc_html_e('Semesters','ystudy-education');?></span>
                </li>
            </ul>

            <?php 
            if ($course_categories && count($course_categories) > 0) {
                // Get the first two categories
                $categories_to_display = array_slice($course_categories, 0, 2);
                echo'<div class="td_card_categories">';
                // Loop through and display each category
                foreach ($categories_to_display as $category) {
                    echo '<a href="' . esc_url(get_term_link($category)) . '" class="td_card_category td_fs_14 td_bold td_heading_color td_mb_14">' 
                    . esc_html($category->name) . '</a>';
                }echo'
                </div>';
            }
            ?>

            <h2 class="td_card_title td_fs_24 td_mb_16"><a href="<?php echo esc_url($course_permalink); ?>"><?php echo esc_html($course_title); ?></a></h2>
            <p class="td_card_subtitle td_heading_color td_opacity_7 td_mb_20"><?php echo wp_trim_words(get_the_content(), 18, '...'); ?></p>
            <div class="td_card_review">
                <?php  do_action('tutor_course/loop/rating'); ?>
            </div>
            <div class="td_card_btn">
                <a href="<?php echo esc_url($course_permalink); ?>" class="td_btn td_style_1 td_radius_10 td_medium">
                    <span class="td_btn_in td_white_color td_accent_bg">
                    <span><?php esc_html_e('Enroll Now','ystudy-education');?></span>
                    </span>             
                </a>
            </div>
        </div>
    </div>
</div>


<?php

// do_action('tutor_course/loop/header');
